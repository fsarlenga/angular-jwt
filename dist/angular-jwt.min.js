angular.module("angular-jwt",["angular-jwt.options","angular-jwt.interceptor","angular-jwt.jwt","angular-jwt.authManager","angular-jwt.headerCompression"]),angular.module("angular-jwt.authManager",[]).provider("authManager",function(){this.$get=["$rootScope","$injector","$location","jwtHelper","jwtInterceptor","jwtOptions",function(e,r,t,n,a,i){var o=i.getConfig();function u(t){return Array.isArray(t)?r.invoke(t,this,{options:null}):t()}function s(t){if(Array.isArray(t)||angular.isFunction(t))return r.invoke(t,o,{});throw new Error("unauthenticatedRedirector must be a function")}function h(){var t=u(o.tokenGetter);if(t)return!n.isTokenExpired(t)}function c(){e.isAuthenticated=!0}function l(){e.isAuthenticated=!1}function d(){var t=u(o.tokenGetter);t&&(n.isTokenExpired(t)?e.$broadcast("tokenHasExpired",t):c())}if(e.isAuthenticated=!1,r.has("$transitions"))r.get("$transitions").onStart({},function(t){var e=t.to(),r=t.router.stateService;if(e&&e.data&&!0===e.data.requiresLogin&&!h())return r.target(o.loginPath)});else{var f=r.has("$state")?"$stateChangeStart":"$routeChangeStart";e.$on(f,function(t,e){if(!e)return!1;var r=e.$$route?e.$$route:e.data;r&&!0===r.requiresLogin&&!h()&&(t.preventDefault(),s(o.unauthenticatedRedirector))})}return{authenticate:c,unauthenticate:l,getToken:function(){return u(o.tokenGetter)},redirect:function(){return s(o.unauthenticatedRedirector)},checkAuthOnRefresh:function(){r.has("$transitions")?r.get("$transitions").onStart({},d):e.$on("$locationChangeStart",d)},redirectWhenUnauthenticated:function(){e.$on("unauthenticated",function(){s(o.unauthenticatedRedirector),l()})},isAuthenticated:h}}]}),angular.module("angular-jwt.interceptor",[]).provider("jwtInterceptor",function(){this.urlParam,this.authHeader,this.authPrefix,this.whiteListedDomains,this.tokenGetter;var o=this;this.$get=["$q","$injector","$rootScope","urlUtils","jwtOptions",function(r,t,e,a,n){var i=angular.extend({},n.getConfig(),o);return{request:function(e){if(e.skipAuthorization||!function(t){if(!a.isSameOrigin(t)&&!i.whiteListedDomains.length)throw new Error("As of v0.1.0, requests to domains other than the application's origin must be white listed. Use jwtOptionsProvider.config({ whiteListedDomains: [<domain>] }); to whitelist.");for(var e=a.urlResolve(t).hostname.toLowerCase(),r=0;r<i.whiteListedDomains.length;r++){var n=i.whiteListedDomains[r];if(n instanceof RegExp){if(e.match(n))return!0}else if(e===n.toLowerCase())return!0}return!!a.isSameOrigin(t)}(e.url))return e;if(i.urlParam){if(e.params=e.params||{},e.params[i.urlParam])return e}else if(e.headers=e.headers||{},e.headers[i.authHeader])return e;return r.when(t.invoke(i.tokenGetter,this,{options:e})).then(function(t){return t&&(i.urlParam?e.params[i.urlParam]=t:e.headers[i.authHeader]=i.authPrefix+t),e})},responseError:function(t){return void 0!==t&&401===t.status&&e.$broadcast("unauthenticated",t),r.reject(t)}}}]}),angular.module("angular-jwt.jwt",[]).service("jwtHelper",["$window","jwOptions",function(r,t){this.urlBase64Decode=function(t){var e=t.replace(/-/g,"+").replace(/_/g,"/");switch(e.length%4){case 0:break;case 2:e+="==";break;case 3:e+="=";break;default:throw"Illegal base64url string!"}return r.decodeURIComponent(escape(r.atob(e)))},this.decodeToken=function(t){var e=jwtOptions.getConfig(),r=(e.headerCompression?e.headerCompression.decompress(t):t).split(".");if(3!==r.length)throw new Error("JWT must have 3 parts");var n=this.urlBase64Decode(r[1]);if(!n)throw new Error("Cannot decode the token");return angular.fromJson(n)},this.getTokenExpirationDate=function(t){var e=this.decodeToken(t);if(void 0===e.exp)return null;var r=new Date(0);return r.setUTCSeconds(e.exp),r},this.isTokenExpired=function(t,e){var r=this.getTokenExpirationDate(t);return e=e||0,null!==r&&!(r.valueOf()>(new Date).valueOf()+1e3*e)}}]),angular.module("angular-jwt.headerCompression",[]).service("defaultCompression",function(){return decompress(token),token}),angular.module("angular-jwt.options",[]).provider("jwtOptions",["defaultCompression",function(r){var n={};this.config=function(t){n=t},this.$get=function(){var t={urlParam:null,authHeader:"Authorization",authPrefix:"Bearer ",whiteListedDomains:[],tokenGetter:function(){return null},loginPath:"/",unauthenticatedRedirectPath:"/",unauthenticatedRedirector:["$location",function(t){t.path(this.unauthenticatedRedirectPath)}],headerCompression:r};function e(){this.config=angular.extend({},t,n)}return e.prototype.getConfig=function(){return this.config},new e}}]),angular.module("angular-jwt.interceptor").service("urlUtils",function(){var r=document.createElement("a"),n=a(window.location.href);function a(t){var e=t;return r.setAttribute("href",e),e=r.href,r.setAttribute("href",e),{href:r.href,protocol:r.protocol?r.protocol.replace(/:$/,""):"",host:r.host,search:r.search?r.search.replace(/^\?/,""):"",hash:r.hash?r.hash.replace(/^#/,""):"",hostname:r.hostname,port:r.port,pathname:"/"===r.pathname.charAt(0)?r.pathname:"/"+r.pathname}}return{urlResolve:a,isSameOrigin:function(t){var e=angular.isString(t)?a(t):t;return e.protocol===n.protocol&&e.host===n.host}}});